---
title: "Analyse temporelle avec nemeton"
author: "Pascal Obst√©tar"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Analyse temporelle avec nemeton}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 6,
  warning = FALSE,
  message = FALSE
)
```

> üåç **English version**: See `vignette("temporal-analysis")` | **Version fran√ßaise** : Ce document

# Introduction

Le package `nemeton` fournit des outils complets pour **l'analyse temporelle** des indicateurs d'√©cosyst√®mes forestiers. Cette vignette d√©montre comment :

- G√©rer des datasets multi-p√©riodes avec `nemeton_temporal()`
- Calculer les taux de changement (absolu et relatif) avec `calculate_change_rate()`
- Visualiser les tendances temporelles avec des graphiques de s√©ries chronologiques
- Cr√©er des heatmaps d'√©volution d'indicateurs
- Comparer des sc√©narios avant/apr√®s intervention

L'analyse temporelle permet aux gestionnaires forestiers de :

- **D√©tecter les tendances** : Identifier les changements √† long terme dans les services √©cosyst√©miques
- **√âvaluer les interventions** : √âvaluer l'impact des actions de gestion
- **Surveiller la r√©silience** : Suivre la r√©cup√©ration apr√®s perturbations
- **Informer les d√©cisions** : Baser les strat√©gies sur les dynamiques observ√©es

# Installation

```{r, eval = FALSE}
# Depuis GitHub
remotes::install_github("pobsteta/nemeton")
```

```{r, eval = FALSE}
library(nemeton)
library(ggplot2)
library(dplyr)
```

# Cr√©er des datasets multi-p√©riodes

## Structure d'un objet temporel

Un objet `nemeton_temporal` contient plusieurs p√©riodes temporelles, chacune avec les m√™mes unit√©s spatiales suivies dans le temps.

```{r, eval = FALSE}
# Charger les donn√©es de d√©mo
data(massif_demo_units)

# Simuler trois p√©riodes temporelles (2015, 2020, 2025)
# En pratique, ces donn√©es proviendraient de sources diff√©rentes

# P√©riode 1 : 2015 baseline
units_2015 <- massif_demo_units[1:10, ]
units_2015$period <- "2015"
units_2015$parcel_id <- paste0("P", sprintf("%03d", 1:10))
units_2015$carbon <- rnorm(10, mean = 150, sd = 20)
units_2015$biodiversity <- rnorm(10, mean = 12, sd = 3)
units_2015$water <- rnorm(10, mean = 8, sd = 2)

# P√©riode 2 : 2020 interm√©diaire (croissance)
units_2020 <- massif_demo_units[1:10, ]
units_2020$period <- "2020"
units_2020$parcel_id <- paste0("P", sprintf("%03d", 1:10))
units_2020$carbon <- units_2015$carbon * runif(10, 1.05, 1.15)  # 5-15% croissance
units_2020$biodiversity <- units_2015$biodiversity + rnorm(10, mean = 1, sd = 0.5)
units_2020$water <- units_2015$water + rnorm(10, mean = 0, sd = 0.3)

# P√©riode 3 : 2025 r√©cent (croissance continue + effets intervention)
units_2025 <- massif_demo_units[1:10, ]
units_2025$period <- "2025"
units_2025$parcel_id <- paste0("P", sprintf("%03d", 1:10))
units_2025$carbon <- units_2020$carbon * runif(10, 1.08, 1.20)
units_2025$biodiversity <- units_2020$biodiversity + rnorm(10, mean = 1.5, sd = 0.8)
units_2025$water <- units_2020$water + rnorm(10, mean = 0.5, sd = 0.4)
```

## Cr√©er l'objet temporel

```{r, eval = FALSE}
# Cr√©er le dataset temporel
temporal_data <- nemeton_temporal(
  periods = list(
    "2015" = units_2015,
    "2020" = units_2020,
    "2025" = units_2025
  ),
  id_column = "parcel_id"
)

# Inspecter l'objet temporel
print(temporal_data)
```

```{r, eval = FALSE}
# Statistiques sommaires
summary(temporal_data)
```

L'objet temporel suit :

- **3 p√©riodes** (2015, 2020, 2025)
- **10 unit√©s spatiales** (parcelles P001-P010)
- **3 indicateurs** (carbon, biodiversity, water)
- **Identifiants coh√©rents** dans le temps (parcel_id)

# Calculer les taux de changement

## Taux de changement absolu

Le changement absolu quantifie la diff√©rence brute entre p√©riodes (ex: Mg C/ha/an).

```{r, eval = FALSE}
# Calculer les taux de changement absolus pour tous les indicateurs
rates_absolute <- calculate_change_rate(
  temporal_data,
  indicators = c("carbon", "biodiversity", "water"),
  type = "absolute"
)

# Inspecter les r√©sultats
head(rates_absolute)
```

```{r, eval = FALSE}
# R√©sum√© du taux de changement du carbone
cat("\n=== Taux de changement du carbone (Mg C/parcelle/an) ===\n")
summary(rates_absolute$carbon_rate_abs)

# Identifier les parcelles avec l'accumulation de carbone la plus √©lev√©e
top_carbon <- rates_absolute %>%
  sf::st_drop_geometry() %>%
  arrange(desc(carbon_rate_abs)) %>%
  head(3)

cat("\nTop 3 des parcelles pour l'accumulation de carbone :\n")
print(top_carbon[, c("parcel_id", "carbon_rate_abs")])
```

## Taux de changement relatif

Le changement relatif exprime le changement en pourcentage de la baseline (ex: %/an).

```{r, eval = FALSE}
# Calculer les taux de changement relatifs
rates_relative <- calculate_change_rate(
  temporal_data,
  indicators = c("carbon", "biodiversity", "water"),
  type = "relative"
)

# R√©sum√© du changement de biodiversit√© (%)
cat("\n=== Taux de changement de la biodiversit√© (%/an) ===\n")
summary(rates_relative$biodiversity_rate_rel)

# Identifier les parcelles avec l'augmentation de biodiversit√© la plus √©lev√©e
top_bio <- rates_relative %>%
  sf::st_drop_geometry() %>%
  arrange(desc(biodiversity_rate_rel)) %>%
  head(3)

cat("\nTop 3 des parcelles pour l'augmentation de biodiversit√© :\n")
print(top_bio[, c("parcel_id", "biodiversity_rate_rel")])
```

## Absolu et relatif simultan√©s

Calculer les deux types simultan√©ment :

```{r, eval = FALSE}
# Les deux types de taux
rates_both <- calculate_change_rate(
  temporal_data,
  indicators = c("carbon", "biodiversity", "water"),
  type = "both"
)

# V√©rifier les colonnes
cat("\nColonnes disponibles :\n")
grep("_rate_", names(rates_both), value = TRUE)
```

# Visualisations temporelles

## Graphiques de tendances temporelles

Visualiser l'√©volution des indicateurs √† travers toutes les p√©riodes.

```{r, eval = FALSE, fig.cap = "√âvolution du stock de carbone (2015-2025)"}
# Tendances du carbone dans le temps
plot_temporal_trend(
  temporal_data,
  indicator = "carbon",
  title = "√âvolution du stock de carbone (2015-2025)"
)
```

```{r, eval = FALSE, fig.cap = "Tendances multi-indicateurs", fig.height = 8}
# Indicateurs multiples
plot_temporal_trend(
  temporal_data,
  indicator = c("carbon", "biodiversity", "water"),
  title = "Tendances temporelles multi-indicateurs"
)
```

# Cas d'usage : Avant/Apr√®s intervention

## Simuler une intervention de gestion foresti√®re

```{r, eval = FALSE}
# Sc√©nario : √âclaircie s√©lective en 2020 affectant le carbone et la biodiversit√©

# Avant intervention (2015)
units_before <- massif_demo_units[1:5, ]
units_before$parcel_id <- paste0("P", 1:5)
units_before$carbon <- c(120, 135, 128, 142, 138)
units_before$biodiversity <- c(10, 11, 9, 12, 10)

# Apr√®s intervention (2025) - l'√©claircie augmente la biodiversit√©, r√©duit le carbone √† court terme
units_after <- massif_demo_units[1:5, ]
units_after$parcel_id <- paste0("P", 1:5)
units_after$carbon <- c(110, 125, 118, 132, 128)       # -8% carbone
units_after$biodiversity <- c(14, 15, 13, 16, 14)     # +40% biodiversit√©

# Cr√©er l'objet temporel
intervention <- nemeton_temporal(
  periods = list("2015" = units_before, "2025" = units_after),
  id_column = "parcel_id"
)

print(intervention)
```

## √âvaluer les effets de l'intervention

```{r, eval = FALSE}
# Calculer les taux de changement
intervention_rates <- calculate_change_rate(
  intervention,
  indicators = c("carbon", "biodiversity"),
  type = "both"
)

# R√©sum√©
cat("\n=== R√©sum√© de l'impact de l'intervention ===\n")
cat("\nChangement du carbone (absolu) :\n")
summary(intervention_rates$carbon_rate_abs)

cat("\nChangement de la biodiversit√© (absolu) :\n")
summary(intervention_rates$biodiversity_rate_abs)

# Analyse des compromis
tradeoff <- intervention_rates %>%
  sf::st_drop_geometry() %>%
  select(parcel_id, carbon_rate_abs, biodiversity_rate_abs)

cat("\nAnalyse des compromis :\n")
print(tradeoff)
```

```{r, eval = FALSE, fig.cap = "Impact de l'intervention sur la biodiversit√©"}
# Visualiser l'augmentation de la biodiversit√©
plot_temporal_trend(
  intervention,
  indicator = "biodiversity",
  title = "R√©ponse de la biodiversit√© √† l'intervention d'√©claircie"
)
```

# Workflows avanc√©s

## Analyse temporelle multi-famille

Combiner l'analyse temporelle avec le syst√®me multi-famille (voir `vignette("indicator-families_fr")`).

```{r, eval = FALSE}
# Exemple de workflow (n√©cessite des indicateurs de famille calcul√©s)

# Calculer les indicateurs de famille pour chaque p√©riode
layers <- massif_demo_layers()

# P√©riode 1
results_2015 <- nemeton_compute(
  units_2015,
  layers,
  indicators = c("C1", "C2", "W1", "W2", "W3")
)

# P√©riode 2
results_2020 <- nemeton_compute(
  units_2020,
  layers,
  indicators = c("C1", "C2", "W1", "W2", "W3")
)

# Cr√©er des indices de famille pour chaque p√©riode
family_2015 <- create_family_index(results_2015)
family_2020 <- create_family_index(results_2020)

# Analyse temporelle des scores de famille
temporal_families <- nemeton_temporal(
  periods = list("2015" = family_2015, "2020" = family_2020),
  id_column = "parcel_id"
)

# Taux de changement des scores de famille
family_rates <- calculate_change_rate(
  temporal_families,
  indicators = c("family_C", "family_W"),
  type = "both"
)
```

## Normalisation de p√©riode de r√©f√©rence

Normaliser toutes les p√©riodes en utilisant la premi√®re p√©riode comme r√©f√©rence :

```{r, eval = FALSE}
# Extraire les donn√©es de la premi√®re p√©riode
baseline <- temporal_data$periods[[1]]

# Normaliser chaque p√©riode en utilisant la r√©f√©rence baseline
temporal_normalized <- nemeton_temporal(
  periods = lapply(temporal_data$periods, function(period_data) {
    normalize_indicators(
      period_data,
      indicators = c("carbon", "biodiversity", "water"),
      method = "minmax",
      reference_data = baseline  # Utiliser min/max de la baseline
    )
  }),
  id_column = "parcel_id"
)

# Toutes les p√©riodes sont maintenant normalis√©es par rapport √† la baseline (√©chelle 0-100)
```

## D√©tection d'anomalies

Identifier les parcelles avec des patterns de changement inhabituels :

```{r, eval = FALSE}
# Calculer les z-scores des taux de changement
rates_zscore <- rates_absolute %>%
  sf::st_drop_geometry() %>%
  mutate(
    carbon_zscore = scale(carbon_rate_abs)[, 1],
    biodiversity_zscore = scale(biodiversity_rate_abs)[, 1]
  )

# Signaler les anomalies (|z| > 2)
anomalies <- rates_zscore %>%
  filter(abs(carbon_zscore) > 2 | abs(biodiversity_zscore) > 2) %>%
  select(parcel_id, carbon_zscore, biodiversity_zscore)

if (nrow(anomalies) > 0) {
  cat("\nAnomalies d√©tect√©es (|z| > 2) :\n")
  print(anomalies)
} else {
  cat("\nAucune anomalie d√©tect√©e (tous |z| < 2)\n")
}
```

# Export des r√©sultats temporels

## Sauvegarder l'objet temporel

```{r, eval = FALSE}
# Sauvegarder en RDS pour analyse future
saveRDS(temporal_data, "results/temporal_data_2015_2025.rds")

# Charger plus tard
temporal_data <- readRDS("results/temporal_data_2015_2025.rds")
```

## Exporter les taux de changement

```{r, eval = FALSE}
# Exporter en GeoPackage
sf::st_write(
  rates_both,
  "results/change_rates_2015_2025.gpkg",
  delete_dsn = TRUE
)

# Exporter en CSV (sans g√©om√©trie)
rates_table <- rates_both %>%
  sf::st_drop_geometry()

write.csv(
  rates_table,
  "results/change_rates_2015_2025.csv",
  row.names = FALSE
)
```

## Sauvegarder les graphiques

```{r, eval = FALSE}
# Graphique de s√©rie temporelle
p1 <- plot_temporal_trend(temporal_data, indicator = "carbon")
ggsave("figures/carbon_trend_2015_2025.png", p1, width = 10, height = 6, dpi = 300)
```

# R√©sum√©

Le workflow d'analyse temporelle `nemeton` permet :

1. **Gestion multi-p√©riode** : Suivre les indicateurs sur 2+ p√©riodes temporelles
2. **Quantification du changement** : Calculer les taux absolus et relatifs
3. **Visualisation des tendances** : Graphiques de s√©ries temporelles
4. **√âvaluation des interventions** : √âvaluer les impacts de gestion
5. **Int√©gration** : Combiner avec le syst√®me multi-famille pour une analyse compl√®te

## Fonctions cl√©s

- `nemeton_temporal()` : Cr√©er des datasets multi-p√©riodes
- `calculate_change_rate()` : Calculer les taux de changement absolu/relatif
- `plot_temporal_trend()` : Graphiques de lignes de s√©ries temporelles pour toutes les parcelles

## Prochaines √©tapes

- Explorer le syst√®me multi-famille : `vignette("indicator-families_fr")`
- Apprendre les workflows de base : `vignette("getting-started_fr")`
- Consulter la documentation : `help(package = "nemeton")`

# Session Info

```{r, eval = FALSE}
sessionInfo()
```
