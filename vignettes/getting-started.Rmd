---
title: "Getting Started with nemeton"
author: "Pascal Obstétar"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with nemeton}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  warning = FALSE,
  message = FALSE
)
```

# Introduction

The `nemeton` package implements the Nemeton method for systemic forest territory analysis. It provides tools to:

- Calculate 5 biophysical indicators (carbon, biodiversity, water, fragmentation, accessibility)
- Normalize indicator values using multiple methods
- Create composite indices for holistic ecosystem assessment
- Visualize results with publication-ready maps

This vignette demonstrates the complete workflow using the included `massif_demo` synthetic dataset.

# Installation

```{r, eval = FALSE}
# Install from GitHub
remotes::install_github("pobsteta/nemeton")
```

```{r}
library(nemeton)
library(ggplot2)
```

# Load Demo Data

The package includes a synthetic forest dataset (`massif_demo`) representing a 5km × 5km area with 20 forest parcels.

```{r}
# Load forest parcels
data(massif_demo_units)

# Inspect parcels
print(massif_demo_units)

# Summary statistics
cat("\nTotal area:", sum(massif_demo_units$surface_ha), "ha\n")
table(massif_demo_units$forest_type)
```

```{r fig.cap = "Forest parcels by type"}
ggplot(massif_demo_units) +
  geom_sf(aes(fill = forest_type)) +
  theme_minimal() +
  labs(title = "Massif Demo - Forest Types",
       fill = "Forest Type")
```

# Load Spatial Layers

Use `massif_demo_layers()` to load all associated rasters and vectors:

```{r}
layers <- massif_demo_layers()
print(layers)
```

The dataset includes:

- **4 rasters** (25m resolution): biomass, DEM, land cover, species richness
- **2 vector layers**: roads network, water courses

# Compute Biophysical Indicators

## Single Indicator

Calculate carbon stock from biomass data:

```{r}
carbon <- nemeton_compute(
  massif_demo_units,
  layers,
  indicators = "carbon",
  preprocess = TRUE
)

summary(carbon$carbon)
```

## Multiple Indicators

Compute all 5 biophysical indicators:

```{r}
results <- nemeton_compute(
  massif_demo_units,
  layers,
  indicators = "all",
  preprocess = TRUE,
  forest_values = c(1, 2, 3)  # Land cover classes for forests
)

# Inspect results
names(results)
```

```{r}
# Summary of each indicator
cat("\n=== INDICATOR SUMMARIES ===\n\n")

cat("Carbon (Mg C/parcel):\n")
print(summary(results$carbon))

cat("\nBiodiversity (species richness):\n")
print(summary(results$biodiversity))

cat("\nWater regulation index:\n")
print(summary(results$water))

cat("\nForest coverage (%):\n")
print(summary(results$fragmentation))

cat("\nAccessibility (distance to roads, m):\n")
print(summary(results$accessibility))
```

# Normalize Indicators

Normalize to 0-100 scale for comparability:

```{r}
normalized <- normalize_indicators(
  results,
  indicators = c("carbon", "biodiversity", "water", "fragmentation"),
  method = "minmax"
)

# Check normalized values
summary(normalized$carbon_norm)
```

## Invert Accessibility

Convert accessibility to "wilderness" index (low access = high wilderness):

```{r}
normalized <- invert_indicator(
  normalized,
  indicators = "accessibility_norm",
  suffix = "_wilderness"
)
```

# Create Composite Indices

## Ecosystem Health Index

Combine multiple indicators into a single ecosystem health score:

```{r}
ecosystem_health <- create_composite_index(
  normalized,
  indicators = c("carbon_norm", "biodiversity_norm", "water_norm"),
  weights = c(0.4, 0.4, 0.2),
  name = "ecosystem_health"
)

summary(ecosystem_health$ecosystem_health)
```

## Conservation Value Index

Prioritize biodiversity and wilderness:

```{r}
conservation_value <- create_composite_index(
  normalized,
  indicators = c("biodiversity_norm", "accessibility_norm_wilderness"),
  weights = c(0.6, 0.4),
  name = "conservation_value"
)
```

# Visualize Results

## Single Indicator Map

```{r fig.cap = "Carbon stock distribution"}
plot_indicators_map(
  results,
  indicators = "carbon",
  palette = "Greens",
  title = "Carbon Stock Distribution",
  legend_title = "Mg C/parcel"
)
```

## Multiple Indicators (Faceted)

```{r fig.cap = "Normalized biophysical indicators", fig.width = 9, fig.height = 6}
plot_indicators_map(
  normalized,
  indicators = c("carbon_norm", "biodiversity_norm", "water_norm"),
  palette = "viridis",
  facet = TRUE,
  ncol = 3,
  title = "Normalized Biophysical Indicators (0-100)"
)
```

## Composite Index Map

```{r fig.cap = "Ecosystem health index"}
plot_indicators_map(
  ecosystem_health,
  indicators = "ecosystem_health",
  palette = "RdYlGn",
  title = "Ecosystem Health Index",
  legend_title = "Health Score"
)
```

# Advanced Usage

## Reference-Based Normalization

Normalize new data using baseline statistics:

```{r eval = FALSE}
# Baseline data (e.g., from year 2020)
baseline <- nemeton_compute(units_2020, layers_2020, indicators = "all")
baseline_norm <- normalize_indicators(baseline, method = "minmax")

# New data (e.g., from year 2024)
new_data <- nemeton_compute(units_2024, layers_2024, indicators = "all")

# Normalize using baseline min/max
new_norm <- normalize_indicators(
  new_data,
  reference_data = baseline,
  method = "minmax"
)
```

## Scenario Comparison

Compare two different scenarios:

```{r eval = FALSE}
# Current state vs. management scenario
plot_comparison_map(
  current_state,
  managed_scenario,
  indicator = "carbon",
  labels = c("Current (2024)", "Managed (2050)"),
  palette = "Greens"
)
```

## Change Analysis

Visualize changes over time:

```{r eval = FALSE}
# Absolute change
plot_difference_map(
  baseline,
  current,
  indicator = "carbon",
  type = "absolute",
  title = "Carbon Stock Change (Mg C)"
)

# Relative change (%)
plot_difference_map(
  baseline,
  current,
  indicator = "carbon",
  type = "relative",
  title = "Carbon Stock Change (%)"
)
```

# Exporting Results

Save results as GeoPackage or Shapefile:

```{r eval = FALSE}
# Export results
sf::st_write(
  ecosystem_health,
  "results/ecosystem_health_2024.gpkg",
  delete_dsn = TRUE
)

# Save plots
ggsave(
  "figures/ecosystem_health.png",
  width = 10,
  height = 8,
  dpi = 300
)
```

# Summary

The `nemeton` package provides a complete workflow for forest ecosystem analysis:

1. **Data preparation**: Load spatial units and layers
2. **Indicator calculation**: Compute biophysical metrics
3. **Normalization**: Scale indicators for comparability
4. **Aggregation**: Create composite indices
5. **Visualization**: Generate publication-ready maps

For more information, see:

- Package documentation: `help(package = "nemeton")`
- GitHub repository: <https://github.com/pobsteta/nemeton>

# Session Info

```{r}
sessionInfo()
```
