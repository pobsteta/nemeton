---
title: "Familles d'indicateurs - Référentiel complet"
author: "Pascal Obstétar"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Familles d'indicateurs - Référentiel complet}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  warning = FALSE,
  message = FALSE
)
```

# Introduction

Le package `nemeton` structure l'évaluation des services écosystémiques forestiers autour de **12 familles d'indicateurs** couvrant les dimensions biophysiques, écologiques et socio-économiques. Cette vignette présente le référentiel complet et démontre l'utilisation du système de familles.

**Version actuelle : v0.3.0** - **9 familles sur 12 implémentées** avec 23 indicateurs opérationnels.

```{r}
library(nemeton)
library(ggplot2)
```

# Référentiel des 12 familles

## Vue d'ensemble

| Code | Famille | Description | Nb indicateurs |
|------|---------|-------------|----------------|
| **C** | Carbone & Vitalité | Stock carbone et santé végétation | 2 |
| **B** | Biodiversité | Diversité structurelle et habitats | 3 |
| **W** | Eau | Régulation hydrique | 3 |
| **A** | Air & Microclimat | Qualité de l'air et régulation climatique | 2 |
| **F** | Fertilité des sols | Qualité pédologique et érosion | 2 |
| **L** | Landscape (Paysage) | Structure et connectivité paysagère | 3 |
| **T** | Temps & Dynamique | Ancienneté et trajectoires | 2 |
| **R** | Risques | Vulnérabilité aux perturbations | 3 |
| **S** | Social & Usages | Accessibilité et services récréatifs | 3 |
| **P** | Production | Productivité forestière | 3 |
| **E** | Énergie | Potentiel énergétique et climat | 2 |
| **N** | Naturalité | Degré de naturalité | 3 |

## Famille C : Carbone & Vitalité

```{r, eval = FALSE}
# C1 - Stock de biomasse aérienne (tC/ha)
carbon_biomass <- nemeton_compute(
  units,
  layers,
  indicators = "carbon_biomass"
)

# C2 - NDVI et tendance vitalité
carbon_ndvi <- nemeton_compute(
  units,
  layers,
  indicators = "carbon_ndvi"
)
```

**Interprétation** :
- C1 > 100 tC/ha : Fort stock de carbone
- C2 (NDVI) > 0.7 : Végétation très active

## Famille W : Eau

```{r, eval = FALSE}
# W1 - Densité réseau hydrographique (m/ha)
water_network <- nemeton_compute(
  units,
  layers,
  indicators = "water_network"
)

# W2 - Surface en zones humides (%)
water_wetlands <- nemeton_compute(
  units,
  layers,
  indicators = "water_wetlands"
)

# W3 - Topographic Wetness Index
water_twi <- nemeton_compute(
  units,
  layers,
  indicators = "water_twi"
)
```

**Interprétation** :
- W1 > 50 m/ha : Dense réseau hydrographique
- W2 > 20% : Zone humide significative
- W3 > 10 : Fort potentiel d'accumulation d'eau

## Famille F : Fertilité des sols

```{r, eval = FALSE}
# F1 - Classe de fertilité (BD Sol)
soil_fertility <- nemeton_compute(
  units,
  layers,
  indicators = "soil_fertility"
)

# F2 - Risque d'érosion (pente × couverture)
soil_erosion <- nemeton_compute(
  units,
  layers,
  indicators = "soil_erosion"
)
```

**Interprétation** :
- F1 : 1 (très fertile) à 5 (très pauvre)
- F2 > 5 : Risque d'érosion élevé

## Famille L : Landscape (Paysage)

```{r, eval = FALSE}
# L1 - Fragmentation (nb patches / surface moyenne)
landscape_frag <- nemeton_compute(
  units,
  layers,
  indicators = "landscape_fragmentation"
)

# L2 - Ratio lisière / surface
landscape_edge <- nemeton_compute(
  units,
  layers,
  indicators = "landscape_edge"
)
```

**Interprétation** :
- L1 faible : Continuité forestière
- L2 élevé : Forte proportion de lisière (effet de bord)

## Famille B : Biodiversité (v0.3.0)

```{r, eval = FALSE}
# B1 - Protection réglementaire (% surface en zones protégées)
biodiversity_protection <- indicator_biodiversity_protection(
  units,
  protected_areas = protected_areas,  # sf object ZNIEFF, Natura2000
  source = "local"  # ou "wfs" pour téléchargement automatique
)

# B2 - Diversité structurelle (Shannon)
biodiversity_structure <- indicator_biodiversity_structure(
  units,
  strata_field = "strata",          # Strates (Emergent, Dominant, etc.)
  age_class_field = "age_class",    # Classes d'âge
  species_field = "species",        # Essences
  method = "shannon",               # ou "simpson"
  weights = c(strata = 0.4, age = 0.3, species = 0.3)
)

# B3 - Connectivité écologique (distance corridors)
biodiversity_connectivity <- indicator_biodiversity_connectivity(
  units,
  corridors = corridors_sf,  # Trames vertes et bleues
  distance_method = "edge",  # ou "centroid"
  max_distance = 3000        # Distance max en mètres
)
```

**Interprétation** :
- B1 > 50% : Protection significative
- B2 (Shannon) > 1.5 : Diversité structurelle élevée
- B3 < 500m : Excellente connectivité écologique

## Famille R : Risques & Résilience (v0.3.0)

```{r, eval = FALSE}
# R1 - Risque incendie (pente + essence + climat)
risk_fire <- indicator_risk_fire(
  units,
  dem = dem_raster,              # Modèle numérique de terrain
  species_field = "species",     # Champ essence
  climate = climate_data         # Température, précipitations
)

# R2 - Vulnérabilité tempête (hauteur + densité + exposition)
risk_storm <- indicator_risk_storm(
  units,
  dem = dem_raster,
  height_field = "height",       # Hauteur dominante (m)
  density_field = "density"      # Densité (0-1)
)

# R3 - Stress hydrique (TWI + climat + essences)
risk_drought <- indicator_risk_drought(
  units,
  twi_field = "W3",              # Topographic Wetness Index
  climate = climate_data,
  species_field = "species"
)
```

**Interprétation** :
- R1, R2, R3 > 60 : Vulnérabilité élevée
- Risques cumulés (≥2 indicateurs élevés) : Priorité gestion préventive

## Famille T : Trame Temporelle (v0.3.0)

```{r, eval = FALSE}
# T1 - Ancienneté des peuplements (années)
temporal_age <- indicator_temporal_age(
  units,
  age_field = "age",                    # Âge actuel
  establishment_year_field = "planted"  # Année plantation (optionnel)
)

# T2 - Changements d'occupation du sol (%/an)
temporal_change <- indicator_temporal_change(
  units,
  land_cover_early = lc_1990_raster,
  land_cover_late = lc_2020_raster,
  years_elapsed = 30,
  interpretation = "stability"  # ou "dynamism"
)
```

**Interprétation** :
- T1 > 150 ans : Forêt ancienne (haute valeur patrimoniale)
- T2 < 1%/an : Stabilité de l'occupation
- T2 > 3%/an : Dynamique forte (urbanisation, déprise agricole)

## Famille A : Air & Microclimat (v0.3.0)

```{r, eval = FALSE}
# A1 - Couverture arborée dans buffer 1km (%)
air_coverage <- indicator_air_coverage(
  units,
  land_cover = land_cover_raster,
  buffer_radius = 1000  # Rayon en mètres
)

# A2 - Qualité de l'air (indice ou proxy distance)
air_quality <- indicator_air_quality(
  units,
  roads = roads_sf,           # Réseau routier (optionnel)
  urban_areas = urban_sf,     # Zones urbaines (optionnel)
  atmo_data = NULL,           # Données ATMO si disponibles
  method = "proxy"            # "atmo" si données disponibles
)
```

**Interprétation** :
- A1 > 70% : Couverture arborée dense (forte régulation climatique)
- A2 > 70 : Bonne qualité de l'air

# Système de préfixes et détection automatique

Le package utilise un système de **préfixes de famille** pour organiser les indicateurs :

```{r, eval = FALSE}
# Les indicateurs bruts suivent le pattern : famille_nom
# Exemples :
carbon_biomass    # Famille C
water_network     # Famille W
soil_fertility    # Famille F

# Les indicateurs normalisés ajoutent le suffixe _norm :
carbon_biomass_norm
water_network_norm
```

## Détection automatique de famille

```{r, eval = FALSE}
# Détecter la famille d'un indicateur
detect_indicator_family("carbon_biomass")
# [1] "C"

detect_indicator_family("water_twi_norm")
# [1] "W"

# Obtenir le nom complet de la famille
get_family_name("C")
# [1] "Carbone & Vitalité"

get_family_name("W", lang = "en")
# [1] "Water Regulation"
```

# Normalisation par famille

Normalisez tous les indicateurs d'une ou plusieurs familles :

```{r, eval = FALSE}
# Charger les données
data(massif_demo_units)
layers <- massif_demo_layers()

# Calculer indicateurs des familles C et W
results <- nemeton_compute(
  massif_demo_units,
  layers,
  indicators = c("carbon", "water", "biodiversity")
)

# Normaliser tous les indicateurs
normalized <- normalize_indicators(
  results,
  indicators = c("carbon", "water", "biodiversity"),
  method = "minmax"
)

# Les colonnes normalisées ont le suffixe _norm
names(normalized)
```

# Indices composites par famille

Créez des indices agrégés par famille avec `create_family_index()` :

```{r, eval = FALSE}
# Exemple fictif (nécessite indicateurs C1 et C2)
# Indice famille C (Carbone)
score_carbon <- create_family_index(
  normalized,
  family = "C",
  name = "score_carbon"
)

# Indice famille W (Eau)
score_water <- create_family_index(
  normalized,
  family = "W",
  name = "score_water"
)
```

**Fonctionnement** :
- Détecte automatiquement les indicateurs de la famille (préfixe)
- Agrège par moyenne arithmétique (par défaut)
- Crée une nouvelle colonne avec le nom spécifié

# Visualisation multi-famille

## Radar chart 12 familles

```{r, eval = FALSE}
# Créer scores pour chaque famille
families <- c("C", "W", "F", "L")
for (fam in families) {
  normalized <- create_family_index(
    normalized,
    family = fam,
    name = paste0("score_", tolower(fam))
  )
}

# Radar avec 4 familles
nemeton_radar(
  normalized,
  unit_id = "P01",
  indicators = c("score_c", "score_w", "score_f", "score_l"),
  title = "Profil multi-famille - Parcelle P01"
)
```

## Cartes par famille

```{r, eval = FALSE}
# Visualiser les scores de famille
plot_indicators_map(
  normalized,
  indicators = c("score_c", "score_w", "score_f"),
  palette = "viridis",
  facet = TRUE,
  ncol = 3,
  title = "Scores par famille"
)
```

# Analyse croisée inter-familles (v0.3.0)

La v0.3.0 introduit des outils d'**analyse croisée** pour identifier synergies et conflits entre familles.

## Matrice de corrélations

```{r, eval = FALSE}
# Calculer les corrélations entre indices de familles
corr_matrix <- compute_family_correlations(
  units,
  families = NULL,      # Auto-détection des family_*
  method = "pearson"    # ou "spearman", "kendall"
)

# Visualiser les corrélations
plot_correlation_matrix(
  corr_matrix,
  method = "circle",    # ou "square", "number", "color"
  palette = "RdBu",     # Rouge=synergies, Bleu=conflits
  title = "Synergies et conflits entre services écosystémiques"
)
```

**Interprétation** :
- **Corrélation positive (rouge)** : Synergies (ex: Biodiversité × Ancienneté)
- **Corrélation négative (bleu)** : Conflits/trade-offs (ex: Protection × Risques)
- **Corrélation faible (blanc)** : Indépendance

## Identification de hotspots multi-critères

```{r, eval = FALSE}
# Identifier parcelles excellentes sur plusieurs familles
hotspots <- identify_hotspots(
  units,
  threshold = 80,      # Top 20% pour chaque famille
  min_families = 3     # Au moins 3 familles élevées
)

# Filtrer les hotspots
hotspot_parcels <- hotspots[hotspots$is_hotspot, ]

# Afficher détails
hotspot_parcels[, c("parcel_id", "hotspot_count", "hotspot_families")]

# Cartographier
plot_indicators_map(
  hotspots,
  indicator = "hotspot_count",
  palette = "YlOrRd",
  title = "Nombre de familles à haute valeur"
)
```

**Cas d'usage** :
- **Conservation** : Parcelles à haute biodiversité + ancienneté + connectivité
- **Gestion des risques** : Parcelles cumulant fire + storm + drought
- **Optimisation multi-objectif** : Équilibre production/protection

# Exemple complet : Workflow multi-famille

```{r, eval = FALSE}
# 1. Charger données
data(massif_demo_units)
layers <- massif_demo_layers()

# 2. Calculer indicateurs de 3 familles
results <- nemeton_compute(
  massif_demo_units,
  layers,
  indicators = c(
    "carbon",        # Famille C
    "water",         # Famille W
    "biodiversity"   # Famille B
  )
)

# 3. Normaliser
normalized <- normalize_indicators(
  results,
  indicators = c("carbon", "water", "biodiversity"),
  method = "minmax"
)

# 4. Créer indices par famille
normalized <- create_family_index(normalized, family = "C", name = "score_carbon")
normalized <- create_family_index(normalized, family = "W", name = "score_water")
normalized <- create_family_index(normalized, family = "B", name = "score_bio")

# 5. Indice global multi-famille
global_index <- create_composite_index(
  normalized,
  indicators = c("score_carbon", "score_water", "score_bio"),
  weights = c(0.4, 0.3, 0.3),
  name = "ecosystem_services_index"
)

# 6. Visualisation
plot_indicators_map(
  global_index,
  indicators = "ecosystem_services_index",
  palette = "RdYlGn",
  title = "Indice global de services écosystémiques",
  legend_title = "Score (0-100)"
)
```

# Liste des indicateurs disponibles

Consultez la liste complète des indicateurs implémentés :

```{r, eval = FALSE}
# Lister tous les indicateurs disponibles
list_indicators()

# Filtrer par famille
list_indicators(family = "C")
list_indicators(family = "W")
```

# Roadmap v0.3.0 → v1.0.0

**Version actuelle (v0.3.0)** : **9 familles sur 12 implémentées** (C, B, W, A, F, L, T, R + partiel S)

**Indicateurs opérationnels** :
- ✅ **23 indicateurs** pleinement fonctionnels
- ✅ **Analyse croisée inter-familles** (corrélations, hotspots multi-critères)
- ✅ **Infrastructure temporelle complète** (analyse multi-périodes, détection de changements)
- ✅ **Support bilingue FR/EN**
- ✅ **845+ tests** avec 87% de couverture

**Versions futures** :
- **v0.4.0** : Familles S, P complètes (usages sociaux, production)
- **v0.5.0** : Familles E, N + Dashboard Shiny interactif
- **v1.0.0** : Référentiel complet 12 familles (36 indicateurs) + analyses avancées

# Références

- Référentiel Nemeton : Documentation technique Vivre en Forêt
- Guide méthodologique : `vignette("getting-started_fr")`
- Analyse temporelle : `vignette("temporal-analysis_fr")`
- **Nouveautés v0.3.0** : `vignette("biodiversity-resilience-v030_fr")` - Familles B, R, T, A + Analyse croisée

# Session Info

```{r}
sessionInfo()
```
