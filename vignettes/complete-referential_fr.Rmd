---
title: "Référentiel Complet 12 Familles"
author: "Pascal Obstétar"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Référentiel Complet 12 Familles}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  warning = FALSE,
  message = FALSE
)
```

# Introduction

Avec la version 0.4.0, le package `nemeton` propose un référentiel complet de **12 familles d'indicateurs** pour l'évaluation multi-critères des services écosystémiques forestiers. Cette vignette démontre l'utilisation de l'ensemble du référentiel avec le jeu de données étendu `massif_demo_units_extended`.

## Les 12 Familles

| Code | Famille | Indicateurs | Version |
|------|---------|-------------|---------|
| **C** | Carbone & Vitalité | C1 (biomasse), C2 (NDVI) | v0.2.0 |
| **B** | Biodiversité | B1 (protection), B2 (structure), B3 (connectivité) | v0.3.0 |
| **W** | Eau | W1 (réseau hydro), W2 (zones humides), W3 (TWI) | v0.2.0 |
| **A** | Air & Microclimat | A1 (couverture), A2 (qualité air) | v0.3.0 |
| **F** | Fertilité des Sols | F1 (fertilité), F2 (érosion) | v0.2.0 |
| **L** | Paysage | L1 (fragmentation), L2 (lisière) | v0.2.0 |
| **T** | Temps & Dynamique | T1 (ancienneté), T2 (changements) | v0.3.0 |
| **R** | Risques & Résilience | R1 (incendie), R2 (tempête), R3 (stress) | v0.3.0 |
| **S** | Social & Usages | S1 (sentiers), S2 (accessibilité), S3 (proximité) | v0.4.0 |
| **P** | Production & Économie | P1 (volume), P2 (productivité), P3 (qualité) | v0.4.0 |
| **E** | Énergie & Climat | E1 (bois-énergie), E2 (évitement CO2) | v0.4.0 |
| **N** | Naturalité & Wilderness | N1 (distance infra), N2 (continuité), N3 (composite) | v0.4.0 |

# Chargement des Données

```{r, message=FALSE}
library(nemeton)
library(ggplot2)
library(dplyr)
```

```{r}
# Le jeu de données étendu avec toutes les 12 familles est disponible via LazyData
# Aperçu des données
head(massif_demo_units_extended)
```

# Créer les Indices de Famille

Le système de famille permet d'agréger les indicateurs individuels en indices synthétiques par famille :

```{r}
# Créer tous les indices de famille (12 familles)
# create_family_index() détecte automatiquement toutes les familles par préfixe
result <- create_family_index(massif_demo_units_extended)

# Afficher les indices de famille
result %>%
  sf::st_drop_geometry() %>%
  select(name, starts_with("family_")) %>%
  head()
```

# Visualisation Radar 12-Axes

Le radar 12-axes permet de visualiser le profil complet d'une parcelle sur l'ensemble des 12 familles :

```{r, fig.width=8, fig.height=8}
# Radar pour la parcelle 1 (toutes les 12 familles)
nemeton_radar(
  result,
  unit_id = 1,
  mode = "family"
)
```

# Analyse Croisée Inter-Familles

## Matrice de Corrélation

```{r, fig.width=10, fig.height=9}
# Calculer les corrélations entre toutes les familles
families_all <- c("family_C", "family_B", "family_W", "family_A",
                  "family_F", "family_L", "family_T", "family_R",
                  "family_S", "family_P", "family_E", "family_N")

correlations <- compute_family_correlations(result, families = families_all)

# Visualiser la matrice de corrélation
plot_correlation_matrix(correlations)
```

## Hotspots Multi-Critères

Identifier les parcelles qui excellent simultanément sur plusieurs familles :

```{r}
# Hotspots pour conservation (C, B, N)
hotspots_conservation <- identify_hotspots(
  result,
  families = c("family_C", "family_B", "family_N"),
  threshold = 0.7,
  min_families = 2
)

# Hotspots pour production durable (P, C, E)
hotspots_production <- identify_hotspots(
  result,
  families = c("family_P", "family_C", "family_E"),
  threshold = 0.7,
  min_families = 2
)

# Hotspots pour services sociaux (S, A, L)
hotspots_social <- identify_hotspots(
  result,
  families = c("family_S", "family_A", "family_L"),
  threshold = 0.7,
  min_families = 2
)

# Afficher les hotspots
table(hotspots_conservation$is_hotspot)
table(hotspots_production$is_hotspot)
table(hotspots_social$is_hotspot)
```

# Cartographie Multi-Familles

## Familles Nouvelles (v0.4.0)

```{r, fig.width=10, fig.height=8}
# Visualiser les nouvelles familles S, P, E, N
library(patchwork)

p_social <- ggplot(result) +
  geom_sf(aes(fill = family_S)) +
  scale_fill_viridis_c(name = "Social") +
  labs(title = "Famille S - Social & Usages") +
  theme_minimal()

p_production <- ggplot(result) +
  geom_sf(aes(fill = family_P)) +
  scale_fill_viridis_c(name = "Production") +
  labs(title = "Famille P - Production & Économie") +
  theme_minimal()

p_energy <- ggplot(result) +
  geom_sf(aes(fill = family_E)) +
  scale_fill_viridis_c(name = "Énergie") +
  labs(title = "Famille E - Énergie & Climat") +
  theme_minimal()

p_naturalness <- ggplot(result) +
  geom_sf(aes(fill = family_N)) +
  scale_fill_viridis_c(name = "Naturalité") +
  labs(title = "Famille N - Naturalité & Wilderness") +
  theme_minimal()

(p_social + p_production) / (p_energy + p_naturalness)
```

## Toutes les Familles

```{r, fig.width=12, fig.height=10}
# Créer une facette pour toutes les 12 familles
result_long <- result %>%
  sf::st_drop_geometry() %>%
  tidyr::pivot_longer(
    cols = starts_with("family_"),
    names_to = "famille",
    values_to = "valeur"
  ) %>%
  left_join(
    result %>% select(name, geometry),
    by = "name"
  ) %>%
  sf::st_as_sf()

# Labels des familles pour la facette
family_labels <- c(
  family_C = "C - Carbone",
  family_B = "B - Biodiversité",
  family_W = "W - Eau",
  family_A = "A - Air",
  family_F = "F - Fertilité",
  family_L = "L - Paysage",
  family_T = "T - Temps",
  family_R = "R - Risques",
  family_S = "S - Social",
  family_P = "P - Production",
  family_E = "E - Énergie",
  family_N = "N - Naturalité"
)

ggplot(result_long) +
  geom_sf(aes(fill = valeur)) +
  facet_wrap(~ famille, ncol = 4, labeller = labeller(famille = family_labels)) +
  scale_fill_viridis_c(name = "Score") +
  labs(title = "Référentiel Complet 12 Familles - nemeton v0.4.0") +
  theme_minimal() +
  theme(
    strip.text = element_text(face = "bold"),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  )
```

# Normalisation et Indice Composite

```{r}
# Normaliser tous les indicateurs
result_norm <- normalize_indicators(
  result,
  indicators = c(paste0("C", 1:2), paste0("B", 1:3), paste0("W", 1:3),
                 paste0("A", 1:2), paste0("F", 1:2), paste0("L", 1:2),
                 paste0("T", 1:2), paste0("R", 1:3), paste0("S", 1:3),
                 paste0("P", 1:3), paste0("E", 1:2), paste0("N", 1:3)),
  method = "minmax"
)

# Créer un indice composite global (toutes familles)
result_composite <- create_composite_index(
  result_norm,
  indicators = families_all,
  weights = rep(1, 12),  # Poids égaux pour toutes les familles
  name = "nemeton_index_12"
)

# Visualiser l'indice composite
ggplot(result_composite) +
  geom_sf(aes(fill = nemeton_index_12)) +
  scale_fill_viridis_c(name = "Score", limits = c(0, 100)) +
  labs(title = "Indice Composite Nemeton (12 Familles)") +
  theme_minimal()
```

# Comparaison de Scénarios

```{r}
# Créer différents indices pour différents objectifs de gestion

# Scénario 1: Conservation intégrale
composite_conservation <- create_composite_index(
  result_norm,
  indicators = c("family_C", "family_B", "family_W", "family_N"),
  weights = c(0.3, 0.4, 0.15, 0.15),
  name = "conservation"
)

# Scénario 2: Production durable
composite_production <- create_composite_index(
  result_norm,
  indicators = c("family_P", "family_E", "family_F", "family_C"),
  weights = c(0.4, 0.25, 0.2, 0.15),
  name = "production"
)

# Scénario 3: Services sociaux
composite_social <- create_composite_index(
  result_norm,
  indicators = c("family_S", "family_A", "family_L", "family_R"),
  weights = c(0.35, 0.25, 0.2, 0.2),
  name = "social"
)

# Comparer les scénarios
comparison <- result %>%
  mutate(
    conservation = composite_conservation$conservation,
    production = composite_production$production,
    social = composite_social$social
  ) %>%
  sf::st_drop_geometry() %>%
  select(name, conservation, production, social) %>%
  tidyr::pivot_longer(cols = -name, names_to = "scenario", values_to = "score")

# Visualiser le classement des parcelles selon les scénarios
ggplot(comparison, aes(x = reorder(name, score), y = score, fill = scenario)) +
  geom_col(position = "dodge") +
  coord_flip() +
  scale_fill_viridis_d() +
  labs(
    title = "Classement des Parcelles selon 3 Scénarios de Gestion",
    x = "Parcelle",
    y = "Score",
    fill = "Scénario"
  ) +
  theme_minimal()
```

# Conclusion

Cette vignette a démontré l'utilisation complète du référentiel 12 familles de nemeton v0.4.0. Le package permet maintenant :

1. **Évaluation holistique** : Couvre l'ensemble des dimensions des services écosystémiques (biophysiques, écologiques, sociaux, économiques)
2. **Flexibilité** : Possibilité de créer des indices composites adaptés à différents objectifs de gestion
3. **Analyse croisée** : Identification des synergies et trade-offs entre familles
4. **Visualisation** : Radars 12-axes, cartes multi-familles, matrices de corrélation

Pour aller plus loin, consultez la vignette **"Multi-Criteria Optimization"** qui présente les outils d'analyse Pareto, de clustering et de trade-off analysis.

# Références

- Obstétar, P. (2025). *nemeton: Ecosystem Services Assessment for Forest Management*. R package version 0.4.0.
- MEA (2005). *Millennium Ecosystem Assessment*. Island Press.
- Boitani, L., et al. (2008). *Wilderness: Earth's Last Wild Places*. Conservation International.
