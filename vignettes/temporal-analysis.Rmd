---
title: "Temporal Analysis with nemeton"
author: "Pascal Obstétar"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Temporal Analysis with nemeton}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 6,
  warning = FALSE,
  message = FALSE
)
```

# Introduction

The `nemeton` package provides comprehensive tools for **temporal analysis** of forest ecosystem indicators. This vignette demonstrates how to:

- Manage multi-period datasets with `nemeton_temporal()`
- Calculate change rates (absolute and relative) with `calculate_change_rate()`
- Visualize temporal trends with time-series plots
- Create heatmaps of indicator evolution
- Compare before/after intervention scenarios

Temporal analysis enables forest managers to:

- **Detect trends**: Identify long-term changes in ecosystem services
- **Assess interventions**: Evaluate the impact of management actions
- **Monitor resilience**: Track recovery after disturbances
- **Inform decisions**: Base strategies on observed dynamics

# Installation

```{r, eval = FALSE}
# Install from GitHub
remotes::install_github("pobsteta/nemeton")
```

```{r}
library(nemeton)
library(ggplot2)
library(dplyr)
```

# Creating Multi-Period Datasets

## Temporal Object Structure

A `nemeton_temporal` object contains multiple time periods, each with the same spatial units tracked over time.

```{r}
# Load demo data
data(massif_demo_units)

# Simulate three time periods (2015, 2020, 2025)
# In practice, these would come from different data sources

# Period 1: 2015 baseline
units_2015 <- massif_demo_units[1:10, ]
units_2015$period <- "2015"
units_2015$parcel_id <- paste0("P", sprintf("%03d", 1:10))
units_2015$carbon <- rnorm(10, mean = 150, sd = 20)
units_2015$biodiversity <- rnorm(10, mean = 12, sd = 3)
units_2015$water <- rnorm(10, mean = 8, sd = 2)

# Period 2: 2020 intermediate (some growth)
units_2020 <- massif_demo_units[1:10, ]
units_2020$period <- "2020"
units_2020$parcel_id <- paste0("P", sprintf("%03d", 1:10))
units_2020$carbon <- units_2015$carbon * runif(10, 1.05, 1.15)  # 5-15% growth
units_2020$biodiversity <- units_2015$biodiversity + rnorm(10, mean = 1, sd = 0.5)
units_2020$water <- units_2015$water + rnorm(10, mean = 0, sd = 0.3)

# Period 3: 2025 recent (continued growth + intervention effects)
units_2025 <- massif_demo_units[1:10, ]
units_2025$period <- "2025"
units_2025$parcel_id <- paste0("P", sprintf("%03d", 1:10))
units_2025$carbon <- units_2020$carbon * runif(10, 1.08, 1.20)
units_2025$biodiversity <- units_2020$biodiversity + rnorm(10, mean = 1.5, sd = 0.8)
units_2025$water <- units_2020$water + rnorm(10, mean = 0.5, sd = 0.4)
```

## Create Temporal Object

```{r}
# Create temporal dataset
temporal_data <- nemeton_temporal(
  periods = list(
    "2015" = units_2015,
    "2020" = units_2020,
    "2025" = units_2025
  ),
  id_column = "parcel_id"
)

# Inspect temporal object
print(temporal_data)
```

```{r}
# Summary statistics
summary(temporal_data)
```

The temporal object tracks:

- **3 periods** (2015, 2020, 2025)
- **10 spatial units** (parcels P001-P010)
- **3 indicators** (carbon, biodiversity, water)
- **Consistent identifiers** across time (parcel_id)

# Calculating Change Rates

## Absolute Change Rates

Absolute change quantifies the raw difference between periods (e.g., Mg C/ha/year).

```{r}
# Calculate absolute change rates for all indicators
rates_absolute <- calculate_change_rate(
  temporal_data,
  indicators = c("carbon", "biodiversity", "water"),
  type = "absolute"
)

# Inspect results
head(rates_absolute)
```

```{r}
# Summary of carbon change rate
cat("\n=== Carbon Change Rate (Mg C/parcel/year) ===\n")
summary(rates_absolute$carbon_rate_abs)

# Identify parcels with highest carbon accumulation
top_carbon <- rates_absolute %>%
  sf::st_drop_geometry() %>%
  arrange(desc(carbon_rate_abs)) %>%
  head(3)

cat("\nTop 3 parcels for carbon accumulation:\n")
print(top_carbon[, c("parcel_id", "carbon_rate_abs")])
```

## Relative Change Rates

Relative change expresses change as percentage of baseline (e.g., %/year).

```{r}
# Calculate relative change rates
rates_relative <- calculate_change_rate(
  temporal_data,
  indicators = c("carbon", "biodiversity", "water"),
  type = "relative"
)

# Summary of biodiversity change (%)
cat("\n=== Biodiversity Change Rate (%/year) ===\n")
summary(rates_relative$biodiversity_rate_rel)

# Identify parcels with highest biodiversity increase
top_bio <- rates_relative %>%
  sf::st_drop_geometry() %>%
  arrange(desc(biodiversity_rate_rel)) %>%
  head(3)

cat("\nTop 3 parcels for biodiversity increase:\n")
print(top_bio[, c("parcel_id", "biodiversity_rate_rel")])
```

## Both Absolute and Relative

Calculate both types simultaneously:

```{r}
# Both rate types
rates_both <- calculate_change_rate(
  temporal_data,
  indicators = c("carbon", "biodiversity", "water"),
  type = "both"
)

# Check columns
cat("\nAvailable columns:\n")
grep("_rate_", names(rates_both), value = TRUE)
```

# Temporal Visualizations

## Time-Series Trend Plots

Visualize indicator evolution across all periods.

```{r fig.cap = "Carbon stock evolution (2015-2025)"}
# Carbon trends over time
plot_temporal_trend(
  temporal_data,
  indicator = "carbon",
  title = "Carbon Stock Evolution (2015-2025)",
  ylab = "Carbon (Mg C/parcel)"
)
```

```{r fig.cap = "Multiple indicator trends", fig.height = 8}
# Multiple indicators (faceted)
plot_temporal_trend(
  temporal_data,
  indicator = c("carbon", "biodiversity", "water"),
  facet = TRUE,
  ncol = 1,
  title = "Multi-Indicator Temporal Trends"
)
```

## Heatmap Visualizations

Heatmaps show spatial-temporal patterns (parcels × periods).

```{r fig.cap = "Multi-indicator evolution heatmap for parcel P001", fig.height = 5}
# Multi-indicator heatmap for a single parcel
plot_temporal_heatmap(
  temporal_data,
  unit_id = "P001",
  indicators = c("carbon", "biodiversity", "water"),
  title = "Multi-Indicator Evolution - Parcel P001"
)
```

Heatmaps help identify:

- **Indicator patterns**: Which indicators are changing together
- **Temporal anomalies**: Unexpected changes in specific periods
- **Parcel profiles**: Quick visualization of multi-indicator evolution

# Use Case: Before/After Intervention

## Simulate Forest Management Intervention

```{r}
# Scenario: Selective thinning in 2020 affects carbon and biodiversity

# Before intervention (2015-2020)
units_before <- massif_demo_units[1:5, ]
units_before$parcel_id <- paste0("P", 1:5)
units_before$carbon <- c(120, 135, 128, 142, 138)
units_before$biodiversity <- c(10, 11, 9, 12, 10)

# After intervention (2025) - thinning increases biodiversity, reduces carbon short-term
units_after <- massif_demo_units[1:5, ]
units_after$parcel_id <- paste0("P", 1:5)
units_after$carbon <- c(110, 125, 118, 132, 128)       # -8% carbon
units_after$biodiversity <- c(14, 15, 13, 16, 14)     # +40% biodiversity

# Create temporal object
intervention <- nemeton_temporal(
  periods = list("Before_2015" = units_before, "After_2025" = units_after),
  id_column = "parcel_id"
)

print(intervention)
```

## Evaluate Intervention Effects

```{r}
# Calculate change rates
intervention_rates <- calculate_change_rate(
  intervention,
  indicators = c("carbon", "biodiversity"),
  type = "both"
)

# Summary
cat("\n=== Intervention Impact Summary ===\n")
cat("\nCarbon change (absolute):\n")
summary(intervention_rates$carbon_rate_abs)

cat("\nBiodiversity change (absolute):\n")
summary(intervention_rates$biodiversity_rate_abs)

# Trade-off analysis
tradeoff <- intervention_rates %>%
  sf::st_drop_geometry() %>%
  select(parcel_id, carbon_rate_abs, biodiversity_rate_abs)

cat("\nTrade-off Analysis:\n")
print(tradeoff)
```

```{r fig.cap = "Intervention impact on biodiversity"}
# Visualize biodiversity increase
plot_temporal_trend(
  intervention,
  indicator = "biodiversity",
  title = "Biodiversity Response to Thinning Intervention",
  ylab = "Biodiversity Index"
)
```

# Advanced Workflows

## Multi-Family Temporal Analysis

Combine temporal analysis with the multi-family system (see `vignette("indicator-families")`).

```{r eval = FALSE}
# Example workflow (requires family indicators computed)

# Compute family indicators for each period
layers <- massif_demo_layers()

# Period 1
results_2015 <- nemeton_compute(
  units_2015,
  layers,
  indicators = c("C1", "C2", "W1", "W2", "W3")
)

# Period 2
results_2020 <- nemeton_compute(
  units_2020,
  layers,
  indicators = c("C1", "C2", "W1", "W2", "W3")
)

# Create family indices for each period
family_2015 <- create_family_index(results_2015)
family_2020 <- create_family_index(results_2020)

# Temporal analysis of family scores
temporal_families <- nemeton_temporal(
  periods = list("2015" = family_2015, "2020" = family_2020),
  id_column = "parcel_id"
)

# Family score change rates
family_rates <- calculate_change_rate(
  temporal_families,
  indicators = c("family_C", "family_W"),
  type = "both"
)
```

## Reference Period Normalization

Normalize all periods using the first period as reference:

```{r eval = FALSE}
# Extract first period data
baseline <- temporal_data$periods[[1]]

# Normalize each period using baseline reference
temporal_normalized <- nemeton_temporal(
  periods = lapply(temporal_data$periods, function(period_data) {
    normalize_indicators(
      period_data,
      indicators = c("carbon", "biodiversity", "water"),
      method = "minmax",
      reference_data = baseline  # Use baseline min/max
    )
  }),
  id_column = "parcel_id"
)

# All periods now normalized to baseline (0-100 scale)
```

## Detecting Anomalies

Identify parcels with unusual change patterns:

```{r}
# Calculate z-scores of change rates
rates_zscore <- rates_absolute %>%
  sf::st_drop_geometry() %>%
  mutate(
    carbon_zscore = scale(carbon_rate_abs)[, 1],
    biodiversity_zscore = scale(biodiversity_rate_abs)[, 1]
  )

# Flag anomalies (|z| > 2)
anomalies <- rates_zscore %>%
  filter(abs(carbon_zscore) > 2 | abs(biodiversity_zscore) > 2) %>%
  select(parcel_id, carbon_zscore, biodiversity_zscore)

if (nrow(anomalies) > 0) {
  cat("\nDetected anomalies (|z| > 2):\n")
  print(anomalies)
} else {
  cat("\nNo anomalies detected (all |z| < 2)\n")
}
```

# Exporting Temporal Results

## Save Temporal Object

```{r eval = FALSE}
# Save as RDS for future analysis
saveRDS(temporal_data, "results/temporal_data_2015_2025.rds")

# Load later
temporal_data <- readRDS("results/temporal_data_2015_2025.rds")
```

## Export Change Rates

```{r eval = FALSE}
# Export as GeoPackage
sf::st_write(
  rates_both,
  "results/change_rates_2015_2025.gpkg",
  delete_dsn = TRUE
)

# Export as CSV (without geometry)
rates_table <- rates_both %>%
  sf::st_drop_geometry()

write.csv(
  rates_table,
  "results/change_rates_2015_2025.csv",
  row.names = FALSE
)
```

## Save Plots

```{r eval = FALSE}
# Time-series plot
p1 <- plot_temporal_trend(temporal_data, indicator = "carbon")
ggsave("figures/carbon_trend_2015_2025.png", p1, width = 10, height = 6, dpi = 300)

# Heatmap
p2 <- plot_temporal_heatmap(temporal_data, unit_id = "P001")
ggsave("figures/multi_indicator_heatmap.png", p2, width = 10, height = 6, dpi = 300)
```

# Summary

The `nemeton` temporal analysis workflow enables:

1. **Multi-period management**: Track indicators across 2+ time periods
2. **Change quantification**: Calculate absolute and relative rates
3. **Trend visualization**: Time-series plots and heatmaps
4. **Intervention assessment**: Evaluate management impacts
5. **Integration**: Combine with multi-family system for comprehensive analysis

## Key Functions

- `nemeton_temporal()`: Create multi-period datasets
- `calculate_change_rate()`: Compute absolute/relative change rates
- `plot_temporal_trend()`: Time-series line plots for all parcels
- `plot_temporal_heatmap()`: Multi-indicator heatmap for a single parcel

## Next Steps

- Explore the multi-family system: `vignette("indicator-families")`
- Learn basic workflows: `vignette("getting-started")`
- Check function documentation: `help(package = "nemeton")`

# Session Info

```{r}
sessionInfo()
```
